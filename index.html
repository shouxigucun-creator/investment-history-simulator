<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>å¤œå–°ã‚‰ã„ã®è¿·å®® å®Œæˆç‰ˆ</title>
<style>
body{margin:0;background:#000;color:#eee;font-family:sans-serif}
#top,#game,#gacha{display:none}
h2{text-align:center}
#map{display:grid;grid-template-columns:repeat(9,32px);justify-content:center}
.cell{width:32px;height:32px;border:1px solid #222;text-align:center;line-height:32px}
.wall{background:#111}
.player{background:#09f}
.enemy{background:#900}
.stairs{background:#0a0}
.night .cell{filter:brightness(0.6)}
#ui{padding:6px;font-size:14px;text-align:center}
button{padding:6px;margin:2px}
</style>
</head>
<body>

<div id="top">
<h2>ğŸŒ‘ å¤œå–°ã‚‰ã„ã®è¿·å®®</h2>
<button onclick="drawGacha()">ğŸ° ã‚¬ãƒãƒ£</button>
<button onclick="start()">â–¶ å†’é™ºé–‹å§‹</button>
</div>

<div id="gacha">
<h2>ğŸ° ã‚¬ãƒãƒ£</h2>
<button onclick="roll()">å›ã™</button>
<p id="gachaResult"></p>
<button onclick="back()">æˆ»ã‚‹</button>
</div>

<div id="game">
<div id="ui"></div>
<div id="map"></div>
<div style="text-align:center">
<button onclick="move(0,-1)">â¬†</button><br>
<button onclick="move(-1,0)">â¬…</button>
<button onclick="move(1,0)">â¡</button><br>
<button onclick="move(0,1)">â¬‡</button>
</div>
</div>

<script>
/* ===== ãƒ‡ãƒ¼ã‚¿ ===== */
const pets={
 tiger:{name:"è™",atk:1,hp:0},
 gryphon:{name:"ã‚°ãƒªãƒ•ã‚©ãƒ³",vision:1},
 pegasus:{name:"ãƒšã‚¬ã‚µã‚¹",floorHeal:3}
};
const enemiesBase=[
 {name:"æ•µ",hp:5,atk:2},
 {name:"é‡æ•µ",hp:8,atk:2}
];

/* ===== ã‚»ãƒ¼ãƒ– ===== */
let save=JSON.parse(localStorage.getItem("ned_save")||"{}");
save.pet=save.pet||null;
save.petLv=save.petLv||{};
function saveGame(){localStorage.setItem("ned_save",JSON.stringify(save));}

/* ===== ã‚¬ãƒãƒ£ ===== */
function drawGacha(){
 top.style.display="none"; gacha.style.display="block";
}
function roll(){
 let keys=Object.keys(pets);
 let r=keys[Math.floor(Math.random()*keys.length)];
 save.petLv[r]=(save.petLv[r]||0)+1;
 save.pet=r;
 saveGame();
 gachaResult.textContent=`ğŸ¾ ${pets[r].name} ç²å¾—ï¼Lv${save.petLv[r]}`;
}
function back(){gacha.style.display="none";top.style.display="block";}

/* ===== ã‚²ãƒ¼ãƒ  ===== */
let floor=1,hp=30,food=100;
let px=1,py=1;
let enemies=[],map=[];
const size=9;

function gen(){
 map=[];
 for(let y=0;y<size;y++){
  let r=[];
  for(let x=0;x<size;x++)r.push(Math.random()<0.15?"#":".");
  map.push(r);
 }
 map[1][1]="P"; map[7][7]=">";
 enemies=[];
 let base=enemiesBase[Math.floor(Math.random()*enemiesBase.length)];
 enemies.push({x:5,y:5,hp:base.hp,atk:base.atk});
}

function draw(){
 let night=floor>=21;
 document.body.className=night?"night":"";
 mapDiv.innerHTML="";
 for(let y=0;y<size;y++)for(let x=0;x<size;x++){
  let c="cell";
  if(map[y][x]==="#")c+=" wall";
  if(px==x&&py==y)c+=" player";
  enemies.forEach(e=>{if(e.x==x&&e.y==y)c+=" enemy"});
  if(map[y][x]===">")c+=" stairs";
  mapDiv.innerHTML+=`<div class="${c}"></div>`;
 }
 let petTxt=save.pet?`${pets[save.pet].name}Lv${save.petLv[save.pet]}`:"ãªã—";
 ui.innerHTML=`${floor}F HP:${hp} ğŸ™:${food} ğŸ¾:${petTxt}`;
}

function move(dx,dy){
 let nx=px+dx,ny=py+dy;
 if(map[ny][nx]==="#")return;
 px=nx;py=ny;food--;
 enemiesTurn();
 if(map[py][px]===">"){
  floor++;
  if(save.pet==="pegasus")hp+=pets.pegasus.floorHeal;
  if(floor>30){alert("ğŸ çœŸENDï¼");location.reload();}
  gen();
 }
 if(hp<=0||food<=0){alert("ğŸ’€ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼");location.reload();}
 draw();
}

function enemiesTurn(){
 enemies.forEach(e=>{
  if(Math.abs(px-e.x)+Math.abs(py-e.y)<=1){
   let dmg=e.atk-(save.pet==="tiger"?1:0);
   hp-=Math.max(1,dmg);
  }else{
   e.x+=Math.sign(px-e.x);
   e.y+=Math.sign(py-e.y);
  }
 });
}

/* ===== é–‹å§‹ ===== */
function start(){
 top.style.display="none";game.style.display="block";
 gen();draw();
}
top.style.display="block";
</script>
</body>
</html>
